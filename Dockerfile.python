FROM python:3.11-slim

WORKDIR /app

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y --no-install-recommends \
    git build-essential pkg-config \
    libfreetype6-dev libx11-dev libxext-dev zlib1g-dev \
    ffmpeg curl wget gnupg ca-certificates \
    tor procps && \
    rm -rf /var/lib/apt/lists/*

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ GPAC (MP4Box)
RUN git clone https://github.com/gpac/gpac.git /tmp/gpac && \
    cd /tmp/gpac && ./configure && make -j$(nproc) && make install && \
    cd / && rm -rf /tmp/gpac

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ yt-dlp
RUN curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp && \
    chmod a+rx /usr/local/bin/yt-dlp

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY requirements.txt .
RUN pip install --upgrade pip && \
    pip install -r requirements.txt && \
    pip install python-tornet==2.2.0

# –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç
COPY . .

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV PYTHONPATH=/app
ENV API_TOKEN=""
ENV LOCAL_API_URL=""
ENV MONGO_URI=""

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ –¥–ª—è 40 Tor-–∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
RUN mkdir -p /etc/tor/instances && \
    for i in $(seq 0 39); do \
        port=$((9050 + i * 2)); \
        control_port=$((9051 + i * 2)); \
        dir="/etc/tor/instances/tor$i"; \
        mkdir -p $dir /tmp/tor$i /run/tor$i && \
        chmod 700 /tmp/tor$i /run/tor$i && \
        echo "SocksPort $port" > $dir/torrc && \
        echo "ControlPort $control_port" >> $dir/torrc && \
        echo "CookieAuthentication 1" >> $dir/torrc && \
        echo "DataDirectory /tmp/tor$i" >> $dir/torrc && \
        echo "PidFile /run/tor$i/tor.pid" >> $dir/torrc && \
        echo "MaxCircuitDirtiness 300" >> $dir/torrc && \
        echo "AvoidDiskWrites 1" >> $dir/torrc && \
        echo "User root" >> $dir/torrc; \
    done

# –ó–∞–ø—É—Å–∫: –≤—Å–µ Tor-–∏–Ω—Å—Ç–∞–Ω—Å—ã ‚Üí tornet ‚Üí –±–æ—Ç
üí° –°–æ–≤–µ—Ç—ã
–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ –≤—Å–µ 40 Tor-–∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–∏ —É—Å–ø–µ—à–Ω–æ.
